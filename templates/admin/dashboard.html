<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <style>
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .gallery-item {
            border: 1px solid #ddd;
            padding: 0.5rem;
            border-radius: 4px;
            text-align: center;
        }

        .gallery-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }
    </style>
</head>

<body style="display: block;">
    <div class="dashboard-container">
        <div class="header">
            <div>
                <h1>üéØ Admin Dashboard</h1>
                <p style="margin-top: 0.5rem; color: #6b7280;">Manage your website content</p>
            </div>
            <span>Welcome, <strong>{{ user }}</strong> | <a href="/admin/logout" class="logout-link">Logout</a></span>
        </div>

        {% if request.query_params.error %}
        <div style="background-color: #f8d7da; color: #721c24; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
            Error: {{ request.query_params.error }}
        </div>
        {% endif %}

        <!-- Content Management Section -->
        <section>
            <h2>Manage Text Content</h2>
            <table class="content-table">
                <thead>
                    <tr>
                        <th>Page</th>
                        <th>Section</th>
                        <th>Label</th>
                        <th>Current Text</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in content_items %}
                    <tr>
                        <td>{{ item.page }}</td>
                        <td>{{ item.section }}</td>
                        <td>{{ item.key }}</td>
                        <td>
                            <form action="/admin/update_content" method="POST" class="edit-form">
                                <input type="hidden" name="key" value="{{ item.key }}">
                                <textarea name="value" class="edit-input" rows="3">{{ item.value }}</textarea>
                                <button type="submit" class="save-btn">Update</button>
                            </form>
                        </td>
                        <td></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <!-- Team Members Management Section -->
        <section style="margin-top: 3rem;">
            <h2>Manage Team Members</h2>
            <div class="content-table" style="padding: 1rem; margin-bottom: 2rem;">
                <h3>Add New Team Member</h3>
                <form action="/admin/add_team_member" method="POST" enctype="multipart/form-data">
                    <div class="edit-form"
                        style="display: grid; gap: 1rem; grid-template-columns: 1fr 1fr 1fr; align-items: end;">
                        <input type="text" name="name" class="edit-input" placeholder="Name" required>
                        <input type="text" name="role" class="edit-input" placeholder="Role/Title" required>
                        <input type="text" name="linkedin_url" class="edit-input" placeholder="LinkedIn URL (Optional)">
                        <input type="file" name="image" class="edit-input" required accept="image/*">
                        <button type="submit" class="btn">Add Member</button>
                    </div>
                </form>
            </div>

            <!-- Team Grid Layout for Editing -->
            <div class="gallery-grid" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                {% for member in team_items %}
                <div class="gallery-item" style="text-align: left; padding: 1rem;">
                    <form action="/admin/update_team_member" method="POST" id="edit-form-{{ member.id }}">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <img src="{{ member.image_path }}" alt="Avatar"
                                style="height: 60px; width: 60px; object-fit: cover; border-radius: 50%;">
                            <div style="flex-grow: 1;">
                                <input type="hidden" name="id" value="{{ member.id }}">
                                <label style="font-size: 0.8rem; color: #666;">Name</label>
                                <input type="text" name="name" value="{{ member.name }}" class="edit-input"
                                    style="margin-bottom: 0.5rem;" required>

                                <label style="font-size: 0.8rem; color: #666;">Role</label>
                                <input type="text" name="role" value="{{ member.role }}" class="edit-input"
                                    style="margin-bottom: 0.5rem;" required>

                                <label style="font-size: 0.8rem; color: #666;">LinkedIn URL</label>
                                <input type="text" name="linkedin_url" value="{{ member.linkedin_url }}"
                                    class="edit-input" placeholder="No Link">
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button type="submit" class="save-btn">Save Changes</button>
                        </div>
                    </form>

                    <form action="/admin/delete_team_member" method="POST"
                        onsubmit="return confirm('Delete this member?');"
                        style="margin-top: 0.5rem; text-align: right;">
                        <input type="hidden" name="id" value="{{ member.id }}">
                        <button type="submit" class="delete-btn">Delete Member</button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Gallery Management Section -->
        <section style="margin-top: 3rem;">
            <h2 style="color: #28a745;">üì∏ Main Page Image Galleries</h2>
            <p><strong>Use this section to manage main banner/hero images for service pages.</strong> For individual
                sub-service images (like Warehouse Management, Bund Enhancement), use the section below.</p>
            <p style="background: #fff3cd; padding: 0.75rem; border-left: 4px solid #ffc107; margin-bottom: 1rem;">
                <strong>‚ö†Ô∏è Note:</strong> Maximum 4 images per page gallery.
            </p>

            <div class="content-table" style="padding: 1rem; margin-bottom: 2rem;">
                <h3>Add New Gallery Image</h3>
                <form action="/admin/add_gallery_image" method="POST" enctype="multipart/form-data">
                    <div class="edit-form">
                        <select name="page" class="edit-input" required>
                            <option value="" disabled selected>Select Page</option>
                            <option value="index">Home Page (Team Slideshow)</option>
                            <option value="property-management">Property Management</option>
                            <option value="facilities-management">Facilities Management</option>
                            <option value="specialized-maintenance">Specialized Maintenance</option>
                            <option value="warehouse-management">Warehouse Management</option>
                        </select>

                        <!-- Simple JS to auto-select section based on page, or just text input for now, 
                             but let's make it simpler: hardcode 'gallery' for service pages and 'team_slideshow' for index -->
                        <select name="section" class="edit-input" required>
                            <option value="gallery">Main Gallery (Service Pages)</option>
                            <option value="team_slideshow">Team Slideshow (Home Page)</option>
                        </select>

                        <input type="text" name="title" class="edit-input" placeholder="Image Title (Optional)">
                        <textarea name="description" class="edit-input" placeholder="Image Description (Optional)"
                            rows="2"></textarea>

                        <input type="file" name="image" class="edit-input" required accept="image/*">
                        <button type="submit" class="btn" style="width: auto;">Upload</button>
                    </div>
                </form>
            </div>

            <h3>Existing Main Page Galleries</h3>
            {% set pages = ['index', 'property-management', 'facilities-management', 'specialized-maintenance',
            'warehouse-management'] %}

            {% for page in pages %}
            <div style="margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1rem;">
                <h4>
                    {% if page == 'index' %}Home Page (Team Slideshow){% else %}{{ page|replace('-', ' ')|title }}{%
                    endif %}
                </h4>
                <div class="gallery-grid">
                    {% for item in gallery_items if item.page == page and not item.subsection %}
                    <div class="gallery-item">
                        <img src="{{ item.image_path }}" alt="Gallery Image">
                        <form action="/admin/delete_gallery_image" method="POST"
                            onsubmit="return confirm('Delete this image?');">
                            <input type="hidden" name="id" value="{{ item.id }}">
                            <button type="submit" class="delete-btn">Delete</button>
                        </form>
                    </div>
                    {% else %}
                    <p style="color: #666; font-style: italic;">No images uploaded yet.</p>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

        </section>

        <!-- Sub-Service Image Management Section -->
        <section style="margin-top: 3rem; border-top: 3px solid #007bff; padding-top: 2rem;">
            <h2 style="color: #007bff;">üîß Sub-Service Specific Images</h2>
            <p><strong>Use this section to manage images for individual sub-services within each main service.</strong>
            </p>
            <p style="background: #d1ecf1; padding: 0.75rem; border-left: 4px solid #007bff; margin-bottom: 1rem;">
                <strong>üí° Example:</strong> To add images specifically for "Warehouse Management" or "Bund Enhancement"
                (within Specialized Maintenance), use this section. Each sub-service can have up to 4 images.
            </p>

            <div class="content-table" style="padding: 1.5rem; margin-bottom: 2rem; background: #f8f9fa;">
                <h3 style="margin-top: 0;">üì§ Upload Sub-Service Image</h3>
                <form action="/admin/add_gallery_image" method="POST" enctype="multipart/form-data">
                    <div class="edit-form" style="gap: 1rem;">
                        <div style="grid-column: 1 / -1;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">
                                1Ô∏è‚É£ Select Main Service Page
                            </label>
                            <select name="page" id="page-select" class="edit-input" required
                                onchange="updateSubsectionOptions()">
                                <option value="" disabled selected>Choose a service page...</option>
                                <option value="specialized-maintenance">‚öôÔ∏è Specialized Maintenance</option>
                                <option value="property-management">üè¢ Property Management</option>
                                <option value="facilities-management">üîß Facilities Management</option>
                                <option value="warehouse-management">üì¶ Warehouse Management</option>
                            </select>
                        </div>

                        <input type="hidden" name="section" value="subsection">

                        <div style="grid-column: 1 / -1;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">
                                2Ô∏è‚É£ Select Specific Sub-Service
                            </label>
                            <select name="subsection" id="subsection-select" class="edit-input" required>
                                <option value="" disabled selected>First, select a main service page above...</option>
                            </select>
                        </div>

                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">Image
                                Title (Optional)</label>
                            <input type="text" name="title" class="edit-input"
                                placeholder="e.g., Modern Warehouse Facility">
                        </div>

                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">Choose
                                Image File</label>
                            <input type="file" name="image" class="edit-input" required accept="image/*">
                        </div>

                        <div style="grid-column: 1 / -1;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">Image
                                Description (Optional)</label>
                            <textarea name="description" class="edit-input"
                                placeholder="Brief description of what this image shows..." rows="2"></textarea>
                        </div>

                        <div style="grid-column: 1 / -1;">
                            <button type="submit" class="btn"
                                style="width: auto; padding: 0.75rem 2rem; font-size: 1rem;">
                                ‚úÖ Upload Image
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <h3 style="margin-bottom: 1.5rem;">üìã Manage Existing Sub-Service Images</h3>

            {% set subsection_pages = {
            'specialized-maintenance': [
            ('warehouse-management', 'Warehouse Management'),
            ('bund-enhancement', 'Bund Enhancement'),
            ('waste-disposal', 'Unregulated Waste Disposal'),
            ('tree-removal', 'Tree Removal Works'),
            ('porthole-repair', 'Porthole Repair & Patching'),
            ('scupper-drain', 'Scupper Drain Pipe Replacement'),
            ('water-pipes', 'Clubhouse Water Pipes Repair'),
            ('pedestrian-pathways', 'Pedestrian Pathways Repair'),
            ('exterior-painting', 'Clubhouse Exterior Painting'),
            ('playground-repainting', 'Playground Equipment Repainting'),
            ('drainage-cleaning', 'Drainage System Cleaning'),
            ('scupper-inspection', 'Scupper Drain Inspection'),
            ('signage-installation', 'Signage Installation'),
            ('identification-banner', 'Identification Banner'),
            ('tree-trimming', 'Tree Trimming & Maintenance'),
            ('animal-control', 'Animal Control Trap Install'),
            ('solar-lighting', 'Solar Lighting Maintenance'),
            ('coastal-debris', 'Coastal Debris Cleaning'),
            ('lagoon-cleaning', 'Lagoon Cleaning & Weed Removal'),
            ('wall-fence', 'Wall & Fence Fixing'),
            ('community-events', 'Merdeka & Community Events')
            ],
            'property-management': [],
            'facilities-management': [],
            'warehouse-management': []
            } %}

            {% for page, subsections in subsection_pages.items() %}
            {% if subsections %}
            <div style="margin-top: 2rem; border-top: 2px solid #007bff; padding-top: 1rem;">
                <h4 style="color: #007bff;">{{ page|replace('-', ' ')|title }}</h4>

                {% for subsection_id, subsection_name in subsections %}
                {% set subsection_images = gallery_items|selectattr('page', 'equalto', page)|selectattr('subsection',
                'equalto', subsection_id)|list %}

                <div style="margin-top: 1.5rem; padding-left: 1rem; border-left: 3px solid #eee;">
                    <h5 style="margin-bottom: 0.5rem;">{{ subsection_name }}</h5>
                    {% if subsection_images %}
                    <div class="gallery-grid">
                        {% for item in subsection_images %}
                        <div class="gallery-item" style="padding: 1rem;">
                            <img src="{{ item.image_path }}" alt="{{ item.title or 'Sub-service Image' }}">

                            <!-- Edit Description Form -->
                            <form action="/admin/update_gallery_description" method="POST" style="margin-top: 0.5rem;">
                                <input type="hidden" name="id" value="{{ item.id }}">
                                <input type="text" name="title" value="{{ item.title or '' }}" class="edit-input"
                                    placeholder="Title" style="font-size: 0.85rem; margin-bottom: 0.25rem;">
                                <textarea name="description" class="edit-input" placeholder="Description" rows="2"
                                    style="font-size: 0.85rem; margin-bottom: 0.25rem;">{{ item.description or '' }}</textarea>
                                <button type="submit" class="save-btn"
                                    style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Update</button>
                            </form>

                            <!-- Delete Form -->
                            <form action="/admin/delete_gallery_image" method="POST"
                                onsubmit="return confirm('Delete this image?');" style="margin-top: 0.5rem;">
                                <input type="hidden" name="id" value="{{ item.id }}">
                                <button type="submit" class="delete-btn">Delete</button>
                            </form>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p style="color: #999; font-style: italic; font-size: 0.9rem;">No images uploaded yet.</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endfor %}

        </section>
    </div>

    <script>
        // Dynamic subsection dropdown based on page selection
        const subsectionOptions = {
            'specialized-maintenance': [
                ['warehouse-management', 'Warehouse Management'],
                ['bund-enhancement', 'Bund Enhancement'],
                ['waste-disposal', 'Unregulated Waste Disposal'],
                ['tree-removal', 'Tree Removal Works'],
                ['porthole-repair', 'Porthole Repair & Patching'],
                ['scupper-drain', 'Scupper Drain Pipe Replacement'],
                ['water-pipes', 'Clubhouse Water Pipes Repair'],
                ['pedestrian-pathways', 'Pedestrian Pathways Repair'],
                ['exterior-painting', 'Clubhouse Exterior Painting'],
                ['playground-repainting', 'Playground Equipment Repainting'],
                ['drainage-cleaning', 'Drainage System Cleaning'],
                ['scupper-inspection', 'Scupper Drain Inspection'],
                ['signage-installation', 'Signage Installation'],
                ['identification-banner', 'Identification Banner'],
                ['tree-trimming', 'Tree Trimming & Maintenance'],
                ['animal-control', 'Animal Control Trap Install'],
                ['solar-lighting', 'Solar Lighting Maintenance'],
                ['coastal-debris', 'Coastal Debris Cleaning'],
                ['lagoon-cleaning', 'Lagoon Cleaning & Weed Removal'],
                ['wall-fence', 'Wall & Fence Fixing'],
                ['community-events', 'Merdeka & Community Events']
            ],
            'property-management': [],
            'facilities-management': [],
            'warehouse-management': []
        };

        function updateSubsectionOptions() {
            const pageSelect = document.getElementById('page-select');
            const subsectionSelect = document.getElementById('subsection-select');
            const selectedPage = pageSelect.value;

            // Clear existing options
            subsectionSelect.innerHTML = '<option value="" disabled selected>Select Sub-Service</option>';

            // Add new options
            if (subsectionOptions[selectedPage]) {
                subsectionOptions[selectedPage].forEach(([value, label]) => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = label;
                    subsectionSelect.appendChild(option);
                });
            }
        }
    </script>
</body>

</html>